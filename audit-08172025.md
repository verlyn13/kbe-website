# Staged Next.js 15 + React 19 + Tailwind 4 Audit Checklist

## Execution Instructions for Agent

For each check:

1. **Execute** the exact command provided
2. **Capture** the full output (stdout, stderr, exit code)
3. **Compare** against pass criteria
4. **Document** with evidence (command output, screenshots, file snippets)
5. **Generate** specific fix commands if failing

---

## STAGE 1: Environment & Dependencies Verification

_Must pass before proceeding to Stage 2_

### 1.1 Node Version Alignment

```bash
# Commands to execute
cat package.json | grep -A 5 '"engines"'
node --version
cat .nvmrc 2>/dev/null || cat .node-version 2>/dev/null || echo "No version file found"
cat .github/workflows/*.yml 2>/dev/null | grep -i "node-version" || echo "Check CI config"
```

**Capture:** Version numbers from each source
**Pass Criteria:** All versions match and are ≥ 20.x
**Fix Generator:**

```bash
echo "20.11.0" > .nvmrc
# Update package.json engines field
# Update CI workflow files
```

### 1.2 Package Manager Lock Integrity

```bash
# Execute in sequence
which pnpm && pnpm --version
pnpm install --frozen-lockfile 2>&1 | tee install-output.log
grep -c "WARN" install-output.log
grep -c "peer dep" install-output.log
```

**Capture:** Full install log, warning count, peer dependency issues
**Pass Criteria:** Exit code 0, no peer warnings
**Fix Generator:** Extract specific peer deps and generate install commands

### 1.3 Secret Scanning

```bash
# Critical security check
git ls-files | xargs grep -l -E 'AIza[A-Za-z0-9_-]{35}|sk_live_[A-Za-z0-9]{24}|SG\.[A-Za-z0-9_-]{22}\.[A-Za-z0-9_-]{43}' 2>/dev/null
git ls-files | xargs grep -l -E 'firebase.*apiKey|PRIVATE_KEY|SECRET|PASSWORD' 2>/dev/null | grep -v ".example"
cat .gitignore | grep -E "\.env|firebase.*\.json|serviceAccount"
```

**Capture:** Any files containing potential secrets
**Pass Criteria:** No actual secrets found, .gitignore properly configured
**Critical:** If secrets found, stop audit and address immediately

---

## STAGE 2: Type Safety & Code Quality

_Baseline code health checks_

### 2.1 TypeScript Compilation

```bash
# Full type check with timing
time npx tsc --noEmit --extendedDiagnostics 2>&1 | tee typecheck-output.log
grep -c "error TS" typecheck-output.log
grep "Files:" typecheck-output.log
grep "Time:" typecheck-output.log
```

**Capture:** Error count, file count, compilation time
**Pass Criteria:** 0 errors, compile time < 30s
**Fix Generator:** Parse errors and generate file-specific fixes

### 2.2 Linting Analysis

```bash
pnpm lint 2>&1 | tee lint-output.log
grep -E "error|warning" lint-output.log | head -20
pnpm lint --format json > lint-report.json 2>/dev/null || echo "JSON format not supported"
```

**Capture:** Full lint report, error/warning breakdown by rule
**Pass Criteria:** 0 errors, < 10 warnings
**Fix Generator:** `pnpm lint --fix` for auto-fixable issues

### 2.3 Code Formatting Check

```bash
pnpm format --check 2>&1 | tee format-output.log
# Count unformatted files
grep -c "\.tsx\?$\|\.jsx\?$" format-output.log
```

**Capture:** List of unformatted files
**Pass Criteria:** No unformatted files
**Fix Command:** `pnpm format --write`

---

## STAGE 3: Build & Runtime Verification

_Ensure production readiness_

### 3.1 Production Build

```bash
# Clean build with full output
rm -rf .next
NODE_ENV=production pnpm build 2>&1 | tee build-output.log
grep -E "Compiled|Error|Warning" build-output.log
du -sh .next
ls -la .next/static/chunks/*.js | head -5
```

**Capture:** Build warnings/errors, bundle sizes, chunk analysis
**Pass Criteria:** No errors, First Load JS < 200KB for main pages
**Analysis:** Identify large chunks for splitting

### 3.2 Turbopack Development Parity

```bash
# Start dev server with Turbopack
timeout 30s pnpm dev --turbopack &
DEV_PID=$!
sleep 10
curl -s http://localhost:3000 > dev-home.html
kill $DEV_PID

# Start production server
pnpm build && timeout 30s pnpm start &
PROD_PID=$!
sleep 5
curl -s http://localhost:3000 > prod-home.html
kill $PROD_PID

# Compare outputs
diff -u dev-home.html prod-home.html | head -50
```

**Capture:** HTML differences between dev and prod
**Pass Criteria:** No significant SSR/hydration differences
**Fix:** Document any React 19 specific hydration issues

### 3.3 Edge Runtime Compatibility

```bash
# Find edge runtime declarations
grep -r "runtime.*edge" app/ --include="*.ts" --include="*.tsx"
# Check for Node-only imports in edge files
for file in $(grep -l "runtime.*edge" app/**/*.{ts,tsx} 2>/dev/null); do
  echo "Checking $file for Node APIs:"
  grep -E "require\('fs'\)|require\('crypto'\)|require\('path'\)|import.*from 'fs'" "$file"
done
```

**Capture:** Edge runtime files and their imports
**Pass Criteria:** No Node.js-only APIs in edge runtime files

---

## STAGE 4: React 19 & Tailwind 4 Compatibility

_Framework-specific validation_

### 4.1 React 19 Compatibility

```bash
# Check React version
cat package.json | grep '"react":'
# Look for legacy lifecycle methods
grep -r "componentWillMount\|componentWillReceiveProps\|componentWillUpdate" app/ components/ --include="*.tsx"
# Check for hydration warnings in dev
pnpm dev > dev-console.log 2>&1 &
DEV_PID=$!
sleep 10
curl http://localhost:3000 2>/dev/null
kill $DEV_PID
grep -i "hydration\|warning\|error" dev-console.log
```

**Capture:** React version, legacy code usage, console warnings
**Pass Criteria:** React 19.x, no legacy lifecycles, no hydration errors

### 4.2 Tailwind 4 Migration Status

```bash
# Check Tailwind version and config
cat package.json | grep tailwindcss
cat postcss.config.* 2>/dev/null
# Find deprecated utilities
grep -r "@apply" app/ components/ --include="*.css" | head -10
# Check for removed Tailwind 3 utilities
grep -rE "blur-xs|backdrop-filter" app/ components/ --include="*.tsx"
```

**Capture:** Tailwind version, PostCSS config, deprecated patterns
**Pass Criteria:** Tailwind 4.x, modern PostCSS config, no deprecated utilities

### 4.3 UI Library Compatibility

```bash
# Check Radix UI components
cat package.json | grep "@radix-ui"
# Test for console errors with a simple dev run
echo "import * as Dialog from '@radix-ui/react-dialog'" > test-radix.mjs
node test-radix.mjs 2>&1 | grep -i error || echo "No import errors"
rm test-radix.mjs
```

**Capture:** UI library versions and compatibility status
**Pass Criteria:** All UI libraries compatible with React 19

---

## STAGE 5: Accessibility Audit

_Automated a11y testing_

### 5.1 Install Accessibility Tools

```bash
npm install -g @axe-core/cli lighthouse
# Or use npx in subsequent commands
```

### 5.2 Axe Accessibility Scan

```bash
# Start the dev server
pnpm dev &
DEV_PID=$!
sleep 10

# Run axe on main pages
npx axe http://localhost:3000 --save axe-home.json
npx axe http://localhost:3000/login --save axe-login.json 2>/dev/null || echo "No login page"
npx axe http://localhost:3000/dashboard --save axe-dashboard.json 2>/dev/null || echo "No dashboard"

kill $DEV_PID

# Analyze results
cat axe-*.json | grep -E '"impact":|"description":'
```

**Capture:** Full axe reports with violation details
**Pass Criteria:** 0 critical/serious violations
**Fix Generator:** Specific ARIA fixes per violation

### 5.3 Keyboard Navigation Test

```bash
# Generate a Playwright test for keyboard nav
cat > keyboard-test.spec.ts << 'EOF'
import { test, expect } from '@playwright/test';
test('keyboard navigation', async ({ page }) => {
  await page.goto('/');
  // Tab through interactive elements
  for (let i = 0; i < 10; i++) {
    await page.keyboard.press('Tab');
    const focused = await page.evaluate(() => document.activeElement?.tagName);
    console.log(`Tab ${i}: focused on ${focused}`);
  }
});
EOF

npx playwright test keyboard-test.spec.ts --reporter=json > keyboard-nav-results.json
```

**Capture:** Focus order and trapped states
**Pass Criteria:** Logical tab order, no focus traps

---

## STAGE 6: Security & Authentication

_Critical security validations_

### 6.1 Firebase Configuration

```bash
# Check Firebase config files
ls -la firebase.json firestore.rules storage.rules 2>/dev/null
cat firebase.json | grep -E "hosting|functions|firestore|storage"
# Check for open rules
grep -E "allow read, write: if true" firestore.rules storage.rules 2>/dev/null
```

**Capture:** Firebase configuration and rule strictness
**Pass Criteria:** No open read/write rules
**Critical:** Open rules = immediate fix required

### 6.2 Authentication Implementation

```bash
# Check auth usage patterns
grep -r "onAuthStateChanged\|currentUser\|getIdToken" app/ --include="*.tsx" | head -10
# Look for client-side auth checks
grep -r "useEffect.*auth\|useState.*user" app/ --include="*.tsx" | head -10
# Check server-side validation
grep -r "verifyIdToken\|authenticateUser" app/ lib/ --include="*.ts" | head -10
```

**Capture:** Auth implementation patterns
**Pass Criteria:** Server-side token verification present

### 6.3 Security Headers

```bash
# Check Next.js security headers
cat next.config.* | grep -A 20 "headers"
# Test actual headers
pnpm build && pnpm start &
PROD_PID=$!
sleep 5
curl -I http://localhost:3000 2>/dev/null | grep -E "Content-Security-Policy|Strict-Transport|X-Frame-Options|X-Content-Type"
kill $PROD_PID
```

**Capture:** Security header configuration
**Pass Criteria:** CSP, HSTS, X-Frame-Options present

---

## STAGE 7: Performance Analysis

_Core Web Vitals and bundle analysis_

### 7.1 Lighthouse Performance Audit

```bash
pnpm build && pnpm start &
PROD_PID=$!
sleep 5

# Run Lighthouse
npx lighthouse http://localhost:3000 \
  --output=json \
  --output-path=./lighthouse-home.json \
  --only-categories=performance,accessibility,best-practices,seo

kill $PROD_PID

# Extract key metrics
cat lighthouse-home.json | grep -E '"id":|"score":|"numericValue":' | head -20
```

**Capture:** LCP, FID, CLS, TTI values
**Pass Criteria:** LCP < 2.5s, CLS < 0.1, FID < 100ms

### 7.2 Bundle Analysis

```bash
# Analyze bundle composition
ANALYZE=true pnpm build 2>&1 | tee bundle-analysis.log
# Get sizes of main chunks
ls -lah .next/static/chunks/app/*.js | sort -k5 -h -r | head -10
# Check for large dependencies
grep -E "parsed size|stat size|gzipped size" bundle-analysis.log
```

**Capture:** Bundle sizes, largest dependencies
**Pass Criteria:** Page JS < 300KB, no single dep > 100KB

### 7.3 Image Optimization

```bash
# Check for unoptimized images
grep -r "<img " app/ components/ --include="*.tsx" | grep -v "next/image"
# Verify next/image usage
grep -r "next/image" app/ components/ --include="*.tsx" -c | sort -n -r | head -5
# Check image configurations
cat next.config.* | grep -A 10 "images:"
```

**Capture:** Image component usage, optimization config
**Pass Criteria:** All images use next/image

---

## STAGE 8: Data Layer Security

_Firebase rules and data validation_

### 8.1 Firestore Security Rules Testing

```bash
# Test Firestore rules with emulator
npm install -g firebase-tools
firebase emulators:exec --only firestore --project demo-test 'echo "Emulator started"'

# Create rules test file
cat > test-firestore-rules.js << 'EOF'
// Test unauthorized access
const testRules = async () => {
  // Add actual test logic here based on your rules
  console.log("Testing Firestore rules...");
};
testRules();
EOF

node test-firestore-rules.js
```

**Capture:** Rule test results
**Pass Criteria:** All unauthorized access blocked

### 8.2 API Input Validation

```bash
# Check for Zod schemas
grep -r "z\\.object\|z\\.string\|z\\.number" app/ lib/ --include="*.ts" | head -20
# Look for validation at API boundaries
grep -r "parse\|safeParse\|validate" app/api --include="*.ts" | head -10
```

**Capture:** Validation schema usage
**Pass Criteria:** All API routes have input validation

---

## STAGE 9: Email & External Services

_Third-party integration health_

### 9.1 SendGrid Configuration

```bash
# Check for SendGrid setup
grep -r "sendgrid\|@sendgrid/mail" . --include="*.ts" --include="*.json" | head -5
# Look for email templates
ls -la email-templates/ 2>/dev/null || echo "No email templates directory"
# Check environment variables
cat .env.example | grep -E "SENDGRID|EMAIL" 2>/dev/null
```

**Capture:** Email service configuration
**Pass Criteria:** API keys in env vars, templates present

---

## STAGE 10: CI/CD Pipeline

_Deployment readiness_

### 10.1 CI Configuration

```bash
# Check CI workflow files
ls -la .github/workflows/*.yml 2>/dev/null || ls -la .gitlab-ci.yml 2>/dev/null
# Examine build steps
cat .github/workflows/*deploy*.yml 2>/dev/null | grep -E "run:|name:|uses:"
```

**Capture:** CI pipeline configuration
**Pass Criteria:** Tests run before deploy

### 10.2 Environment Separation

```bash
# Check for environment configs
ls -la .env.* 2>/dev/null
cat firebase.json | grep -E "staging|production|development"
# Verify environment variables documentation
cat README.md | grep -i "environment\|deploy\|configuration" | head -10
```

**Capture:** Environment setup documentation
**Pass Criteria:** Clear env separation

---

## Report Generation Template

```markdown
# Next.js 15 Audit Report

Generated: [DATE]
Repository: [REPO_NAME]
Commit: [SHA]

## Executive Summary

- **Critical Issues**: [COUNT]
- **Warnings**: [COUNT]
- **Passed Checks**: [COUNT/TOTAL]

## Stage Results

### Stage 1: Environment & Dependencies ✅/⚠️/❌

[Specific findings with evidence]

### Remediation Priority

1. **Critical** (Security/Data Loss)
   - [Issue] → [Specific fix command/steps]
2. **High** (Auth/Performance)
   - [Issue] → [Specific fix command/steps]
3. **Medium** (UX/Accessibility)
   - [Issue] → [Specific fix command/steps]

## Fix Script

\`\`\`bash
#!/bin/bash

# Auto-generated fixes

[Specific commands to run]
\`\`\`
```

---

## Agent Execution Tips

1. **Run stages sequentially** - Don't proceed if critical issues found
2. **Capture evidence** - Save command outputs to files
3. **Generate fix scripts** - Create executable remediation steps
4. **Time operations** - Note slow builds or tests
5. **Check multiple times** - Some issues are intermittent
6. **Document assumptions** - Note any inferences made
7. **Create artifacts** - Screenshots for UI issues, JSON for data issues
